---
title: "Yotta è³‡æ–™è¦–è¦ºåŒ–å¯¦æˆ°"
subtitle: "R - ggplot2 åŸºç¤"
author:
    name: "æœ¨åˆ»æ€ - YJ"
    website: "https://www.yottau.com.tw/course/intro/672"
output:
  prettydoc::html_pretty:
    toc: yes
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = TRUE,
                      echo = TRUE,
                      message = FALSE,
                      collapse = FALSE,
                      comment = "#>",
                      fig.align='center',
                      fig.width = 6,
                      cache=FALSE)
library(magrittr)
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(cowplot)

old_theme <- theme_set(theme_light())
```

## ggplot2 ç°¡ä»‹

- [`ggplot2`](http://ggplot2.org) æ˜¯ä¸€å€‹å¾ˆå¼·å¤§çš„è³‡æ–™æ¢ç´¢åŠè¦–è¦ºåŒ–å·¥å…·ï¼Œ
æ˜¯è¨±å¤šæœ€æœ‰å½±éŸ¿åŠ›çš„ R å¥—ä»¶é–‹ç™¼è€… [Hadley Wickham](http://had.co.nz) æ‰€é–‹ç™¼
- æ‰€æœ‰ç¹ªåœ–å‡½æ•¸éƒ½æœ‰èƒŒå¾Œçš„è¦–è¦ºåŒ–é‚è¼¯ï¼ˆ[Grammar of Graphics](http://www.amazon.com/The-Grammar-Graphics-Statistics-Computing/dp/0387245448)ï¼‰

__Grammar of Graphics__ çš„ä½œç”¨å°±æ˜¯å¹«åŠ©æˆ‘å€‘å°‡åœ–è¡¨æ‹†è§£æˆå€‹åˆ¥çš„å…ƒç´ ï¼Œ
ç„¶å¾Œå°‡é€™äº›å…ƒç´ æŒ‰ç…§é‚è¼¯å€‹åˆ¥æ“ä½œï¼Œ***æ­£ç¢º***åˆ***ç°¡å–®***åœ°é”åˆ°åœ–è¡¨çš„ç›®çš„

> It is far better to learn a language by actually speaking it!

## ä¸€å€‹ä¾‹å­å­¸æœƒç•«åœ–ï¼šmpg ğŸš—æ²¹è€—è³‡æ–™

`mpg` dataset:  
Fuel economy data from 1999 and 2008 for 38 popular models of car.

| variable     | detail                                               |
|--------------|------------------------------------------------------|
| manufacturer | è»Šå»                                                  |
| model        | å‹è™Ÿ                                                 |
| displ        | å¼•æ“æ’æ°£é‡                                           |
| year         | å‡ºå» å¹´ä»½                                             |
| cyl          | æ°£ç¼¸æ•¸                                               |
| trans        | è‡ªï¼æ‰‹æ’                                             |
| drv          | f = front-wheel drive, r = rear wheel drive, 4 = 4wd |
| cty          | city miles per gallon åŸå¸‚é§•é§›æ²¹è€—                   |
| hwy          | highway miles per gallon é«˜é€Ÿå…¬è·¯é§•é§›æ²¹è€—            |
| fl           | æ±½æ²¹: ethanol E85, diesel, regular, premium, CNG     |
| class        | è»Šå‹                                                 |

#### ä¸€å€‹ä¾‹å­å­¸æœƒç•«åœ–ï¼šmpg

å…ˆçœ‹å…©å€‹è®Šæ•¸ï¼š

1. displ - å¼•æ“æ’æ°£å…¬å‡
2. hwy - (æ²¹è€—æ•ˆç‡ï¼Œå“©/åŠ ä¾–)

- å¤§å¼•æ“çš„è»Šå­æ›´è€—æ²¹å—ï¼Ÿå¦‚æœæ˜¯çš„è©±ï¼Œé‚£æœ‰å¤šè€—æ²¹ï¼Ÿ
- å¼•æ“å¤§å°å’Œæ²¹è€—æ•ˆç‡ä¹‹é–“çš„é—œä¿‚ç‚ºä½•ï¼Ÿæ­£/è² ç›¸é—œï¼Ÿç·šæ€§/éç·šæ€§ï¼Ÿç›¸é—œç¨‹åº¦ï¼Ÿ

### Scatterplots

```{r}
library(ggplot2)
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy))
```

å¾åœ–è¡¨å¯æ­¸ç´å¹¾å€‹çµè«–ï¼š

1. å…©è®Šæ•¸ç‚ºé«˜åº¦è² ç›¸é—œ â”€â”€ å¤§å¼•æ“ => ä½æ•ˆç‡
2. æœ‰äº›è»Šæ˜¯é›¢ç¾¤å€¼

<img src="img/mpg-outlier.png" style="max-height:auto; max-width:50%;">

```{r, eval=FALSE, include=FALSE}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point() +
  geom_point(data = dplyr::filter(mpg, displ > 5, hwy > 20), colour = "red", size = 2.2)
```


### Exercise: ç”¨ `mpg` è³‡æ–™ç•«ä¸åŒçš„åœ–

çœ‹çœ‹ä¸åŒè®Šæ•¸ä¹‹é–“çš„ç›¸é—œ

- ç•«å‡º scatterplot: `hwy` vs `cyl`
- ç•«å‡º scatterplot: `class` vs `drv`

**Answer-1**

```{r, message=FALSE}
## hwy vs cyl
ggplot(data = mpg) +
  geom_point(mapping = aes(x = hwy, y = cyl))
```

**Answer-2**

```{r, message=FALSE}
## class vs drv
ggplot(data = mpg) +
  geom_point(mapping = aes(x = class, y = drv))
```


## Aesthetic Mapping

- åœ¨ **Grammar of Graphics** è£¡é¢æœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯ **"Aesthetic Mapping"**
- åœ¨ç•«åœ–å‰æˆ‘å€‘å…ˆä¾†ç·´ç¿’ç”¨çœ¼ç›ğŸ‘€çœ‹ **aethetics**

### Exercise: è§€å¯Ÿ Aesthetic Mapping

- æœ‰å“ªäº›è®Šæ•¸ variables
- åˆ†åˆ¥å°æ‡‰åˆ°å“ªå€‹ aethetic

**Aesthetics åŸºæœ¬é¡Œ 1**


```{r, echo=FALSE}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class), size = 3)
```

åœ¨ x-y äºŒç¶­çš„ Scatterplot åŠ å…¥ç¬¬ä¸‰å€‹ aesthetic

- x = displ
- y = hwy
- color = class (æŠŠ class å°æ‡‰åˆ°é»çš„**é¡è‰²**)
- hint: `?geom_point`: æŸ¥è©¢æ”¯æ´çš„ aesthetics

```{r, eval=FALSE}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, color = class))
```

**Aesthetics åŸºæœ¬é¡Œ 2**

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```

- x = displ
- y = hwy
- shape = class

```{r, eval=FALSE}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```

**Plot Exercise**

è©¦è©¦åœ¨ x-y äºŒç¶­çš„ Scatterplot åŠ å…¥ç¬¬ä¸‰å€‹ aesthetic

- æŠŠ class å°æ‡‰åˆ°é»çš„**å½¢ç‹€**

**Answer**

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy, shape = class))
```


### Aesthetic Mappings å°çµ

```{r, eval=FALSE}
ggplot(data = <DATA>) + # Data
  geom_<xxx>(
     mapping = aes(<MAPPINGS>), ##  <= Aesthetic mappings
     stat = <STAT>,
     position = <POSITION>
  ) +
  scale_<xxx>() + coord_<xxx>() + facet_<xxx>()
  theme_()
```

- `aes()` å¯ä»¥æ”¾åœ¨ï¼š
    - `ggplot()`è£¡é¢ -- **æœ‰**"è¨˜æ†¶æ•ˆæœ"(æˆç‚ºæ‰€æœ‰åœ–å±¤é è¨­)
    - å¤–é¢ `+ aes()` -- **æœ‰**"è¨˜æ†¶æ•ˆæœ"(æˆç‚ºæ‰€æœ‰åœ–å±¤é è¨­)
    - `geom_<xxx>()`è£¡é¢ -- **ç„¡**"è¨˜æ†¶æ•ˆæœ"(åªå°è©² geom æœ‰æ•ˆ)
- `geom_<xxx>(inherit.aes=FALSE)`: overrides the default aesthetics.


### Static Aesthetic

æœ‰æ™‚å€™ä½ å¯èƒ½åªæƒ³è¦æ‰‹å‹•è¨­å®šæŸå€‹å›ºå®š aestheticï¼Œé€™è£¡çš„è¨­å®šåªç‚ºäº†ç¾è§€ï¼Œ
ä¸¦ä¸æœƒå¸¶å‡ºå¤šé¤˜è³‡æ–™è¨Šæ¯ã€‚

- å°‡ aesthetic æ”¾åœ¨ aes() è£¡é¢: map aesthetic ä¸¦è‡ªå‹•å»ºç«‹ legend
- å°‡ aesthetic æ”¾åœ¨ aes() ä¹‹å¤–: æ‰‹å‹•è¨­å®šæŸå€‹å›ºå®š aesthetic

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy), color = "blue")
```

### Aesthetics ä¸åªé€™äº›

å¦‚ä½•æŸ¥ï¼Ÿ

- `?geom_`: å„ **geom** æœ‰ä¸åŒæ”¯æ´çš„ aesthetics

<img src="img/aes-search.png" style="max-height:40%; max-width:auto;">


## `ggplot()`

There are two main plotting functions in `ggplot2`:

- `qplot()`: (quick plot) éœ€è¦å¿«é€Ÿç•«åœ–æ™‚æ‰ä½¿ç”¨ï¼Œç”¨æ³•å’Œ R çš„å…§å»ºç¹ªåœ–å‡½æ•¸ `plot()` å·®ä¸å¤š
- `ggplot()`: æ¨è–¦çš„ç¹ªåœ–æ–¹æ³•ï¼Œæ­é…ç¹ªåœ–æ­¥é©Ÿçš„å…¶ä»–å‡½æ•¸é€æ­¥å»ºæ§‹åœ–å±¤

### ggplot2 èµ·æ‰‹å¼

```{r, eval=FALSE}
ggplot(data = <DATA>) + # Data
  geom_<xxx>(
     mapping = aes(<MAPPINGS>),
     stat = <STAT>,
     position = <POSITION>
  ) + # Layers & Aesthetic mappings
  scale_<xxx>() + coord_<xxx>() + facet_<xxx>() # Position
  theme_()
```

### Data for Plot -- ETL

- æ¯ä¸€æ¬„ (column) éƒ½æ˜¯ä¸€å€‹(ç¹ªåœ–)è®Šæ•¸
- æ¯ä¸€åˆ— (row) éƒ½æ˜¯ä¸€ç­†è§€å¯Ÿå€¼
- Wide Format -> Long Format (`tidyr`)
    - [ä½ çš„è³‡æ–™æ˜¯å¯¬çš„é‚„æ˜¯é•·çš„ï¼Ÿ](https://connerchang.github.io/2016/08/12/long-wide-format/)
    
> è³‡æ–™å’Œåœ–è¡¨æ˜¯ä¸€é«”å…©é¢ï¼Œå…ˆæœ‰è³‡æ–™æ‰æœ‰åœ–è¡¨

ä»¥ `mpg` ç‚ºä¾‹

+ `mpg` å…±æœ‰ `r ncol(mpg)` å€‹è®Šæ•¸ `r nrow(mpg)` ç­†è³‡æ–™
+ é€™è£¡éœ€è¦çš„ç¹ªåœ–è®Šæ•¸ (aesthetic mapping)
    - x: `displ`
    - y: `hwy`


```{r, echo=FALSE}
print(mpg)
```

### Geoms

é€™å…©å¼µåœ–å·®åœ¨å“ªè£¡ï¼Ÿ

```{r, echo=FALSE, message=FALSE, fig.width=8, fig.asp=0.5}
library(cowplot)
p1 <- ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy))
p2 <- ggplot(data = mpg) +
  geom_smooth(mapping = aes(x = displ, y = hwy))
cowplot::plot_grid(p1, p2)
```

- Geom æ±ºå®šåœ–è¡¨å‘ˆç¾çš„ã€Œ**å¹¾ä½•åœ–å½¢ç‰©ä»¶**ã€ï¼Œä¹Ÿå°±æ˜¯ä½ çœ¼ç›çœ‹åˆ°çš„è³‡æ–™å‘ˆç¾æ–¹å¼
- `geom_<xxx>()`

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy))
```

```{r}
ggplot(data = mpg) +
  geom_smooth(mapping = aes(x = displ, y = hwy))
```

<img src="img/chart-types.png" style="height:480px; max-width:auto;">

- å› ç‚º Geoms çœŸçš„å¤ªå¤šäº†ï¼Œé€šå¸¸è¦ç”¨çš„æ™‚å€™å†å»æŸ¥: [RStudio - ggplot2 Cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf)
- å¦‚åŒå‰é¢æ‰€è¿°ï¼Œä¸åŒ Geoms æœ‰ä¸åŒæ”¯æ´çš„ Aesthetics

<img src="img/aes-search.png" style="max-height:40%; max-width:auto;">

#### (é™„éŒ„) Geoms -- Cheatsheet

<img src="img/visualization-geoms-1.png" style="max-height:auto; max-width:100%;">

<img src="img/visualization-geoms-2.png" style="max-height:auto; max-width:100%;">

<img src="img/visualization-geoms-3.png" style="max-height:auto; max-width:100%;">

<img src="img/visualization-geoms-4.png" style="max-height:auto; max-width:100%;">


### Bar Charts

- å„ç¨®è»Šå‹(`class`)çš„æ•¸é‡ï¼Ÿ
- `geom_bar()`

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class))
```

åœ¨ç•«åœ–ä¹‹å‰ï¼Œä½ å¯èƒ½è¦å…ˆæƒ³åˆ°ç•«å‡ºé€™æ¨£çš„è¡¨æ ¼ï¼š

```{r, echo=FALSE}
mpg %>% 
  group_by(class) %>% 
  tally %>% 
  knitr::kable()
```

#### è¡¨æ ¼èˆ‡è¦–è¦ºåŒ–çš„é—œè¯

- è¡¨æ ¼å°±æ˜¯ä¸€ç¨®è¦–è¦ºåŒ–çš„æ–¹å¼ï¼Œæœ‰æ™‚å€™ä¸€å¼µå¥½çš„è¡¨æ ¼è³‡è¨Šå°±å¾ˆæ¸…æ¥š
- ç•«åœ–åªæ˜¯å°‡é€™äº›è³‡è¨Šå†å¼·èª¿å‡ºä¾†

<img src="img/mpg-table-viz.png" style="height:540px; max-width:100%;">

#### Try Bar Charts

- å¡«æ»¿é¡è‰² `fill`

(éŒ¯èª¤ç¤ºç¯„ï¼šä¸å»ºè­°åŒä¸€è®Šæ•¸ mapping å¤šå€‹ aes)

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = class))
```

### Stats (Geom çš„ä¸€é«”å…©é¢)

- `stat_<xxx>()`
- æœ‰äº› Geom (ä¾‹å¦‚ scatterplot) ç•«çš„æ˜¯ **raw value** (stat_identity)
- æœ‰äº› Geom (ä¾‹å¦‚ barplot)æœƒè¨ˆç®—æ–°çš„ stat (e.g., count) ä»¥ä¾›ç•«åœ–
- ä½¿ç”¨ `geom_<xxx>()` æ™‚ï¼Œè¦æ³¨æ„é è¨­çš„ stat æ˜¯ä»€éº¼

> æ¯å€‹æˆåŠŸçš„ **Geom** èƒŒå¾Œéƒ½æœ‰ä¸€å€‹å‰å¤§çš„ **Stat**

`stat = "identity"`

<img src="img/visualization-stat-point.png" style="height:520px; max-width:100%;">


å›é ­ä¾†çœ‹ Aesthetic Mapping

- x: `class`
- y: ?? **count** ä¸åœ¨åŸæœ¬çš„ `mpg` è³‡æ–™ä¸­

åˆ°åº• **count** æ˜¯æ€éº¼ç®—å‡ºä¾†çš„ï¼Ÿ

1. åŸæœ¬å¯èƒ½åœ¨ Excel ç®—
2. R å¹«ä½ ç®— `dplyr::summarise()`
3. ggplot2 `geom_bar` å¹«ä½ ç®—

=> `?geom_bar` çš„é è¨­ `stat` æ˜¯ "count"

<img src="img/bar-stats.png" style="max-height:auto; max-width:100%;">

#### Stats æ˜¯æ€éº¼å¹«ä½ ç®—å‡ºä¾†çš„

<img src="img/visualization-stat-bar-mpg.png" style="height:520px; max-width:100%;">

#### å…ˆæ‰‹å‹•è™•ç† stats å†ç•«åœ–

- Plot bar chart with `cut` in dataset `diamonds`

ç”¨ `dplyr::summarise()` ç®—å‡º count é€™å€‹è®Šæ•¸ï¼Œå†ç”¨ `ggplot2` ç•«åœ–

hint: `stat = "identity"`


```{r, collapse=TRUE, fig.width=6}
d <- mpg %>% 
  group_by(class) %>% 
  summarise(n = n())
d

ggplot(data = d) +
  geom_bar(mapping = aes(x = class, y = n),
           stat = "identity")
```

#### ç·´ç¿’: æœ‰æ™‚å€™é‡åˆ°è¤‡é›œçš„å•é¡Œå°±éœ€è¦æ‰‹å‹•å…ˆç®— Stats

- ç•«å‡ºå„ç¨®è»Šå‹(`class`)çš„å¹³å‡æ²¹è€— bar chart

hint:

- `dplyr::group_by()`
- `dplyr::summarise(mean(xxx))`,  
- `geom_bar(stat = "identity")`

```{r, echo=FALSE, collapse=TRUE, fig.width=6}
d <- mpg %>% 
  group_by(class) %>% 
  summarise(mean_hwy = mean(hwy))
d

ggplot(data = d) +
  geom_bar(mapping = aes(x = class, y = mean_hwy),
           stat = "identity")
```

#### æ²’æœ‰æ’åºçš„ bar chart å¾ˆé›£çœ‹

- è¦æ€éº¼æ’åºï¼Ÿ
- `reorder(<è¦æ’åºçš„è®Šæ•¸>, <åƒç…§å¤§å°>)`

```{r, collapse=TRUE, fig.width=6}
d <- mpg %>% 
  group_by(class) %>% 
  summarise(n = n())
d

ggplot(data = d) +
  geom_bar(mapping = aes(x = reorder(class, -n), y = n),
           stat = "identity")
```

### Geoms + Stats å¯¦ä¾‹

- **bar charts**, **histograms**: è¨ˆç®—æ¯ä¸€çµ„ bin è£¡é¢çš„æ•¸ç›®.

```{r}
ggplot(data = mpg, aes(x = class)) +
  geom_bar() +
  geom_text(stat = "count",
            aes(label = ..count.., y =..count..),
            vjust = "bottom")
```


- å„ç¨®è»Šå‹çš„æ²¹è€—æ•ˆç‡
- **boxplots**: plot quartiles.

```{r}
ggplot(data = mpg) +
  geom_boxplot(mapping = aes(x = class, y = hwy))
```


### Layers åœ–å±¤è§€å¿µ

è¦å‘ˆç¾å¤šå€‹å¹¾ä½•åœ–å½¢ç‰©ä»¶ (Geoms) æ™‚è¦æ€éº¼åšåˆ°å‘¢ï¼Ÿ

- ä¸€å€‹ `geom_<xxx>()` å°±æœƒåœ¨åœ–ä¸Šç•«ä¸€åœ–å±¤ (Layer)
- å¯ä¸€å±¤å±¤ç–ŠåŠ ä¸Šå»
- æ¯å€‹åœ–å±¤ç”šè‡³å¯ä»¥ç”¨ä¸åŒçš„ dataï¼Œåœ¨ç•«é€²éšåœ–è¡¨æ™‚å¾ˆå¸¸ç”¨åˆ°
- ä½†è¦æ³¨æ„æ˜¯å¦æœ‰é è¨­çš„ aesthetic ä¸å°å¿ƒ mapping åˆ°è©²åœ–å±¤

**å…©å±¤åœ–å±¤**

```{r}
ggplot(data = mpg) +
  geom_point(mapping = aes(x = displ, y = hwy)) +
  geom_smooth(mapping= aes(x = displ, y = hwy))
```


### (é™„éŒ„) Positionsï¼šç•¶åœ–å½¢åœ¨ä½ç½®æ‰“æ¶æ™‚è¦æ€éº¼è¾¦ï¼Ÿ

- `?geom_bar`
- å †ç–Šï¼š`position = "stack"` (default)

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "stack") +
  ggtitle('Position = "stack"')
```

**`position`: **

- "identity" åŒä¸€ä½ç½®ï¼ˆè¦†è“‹ä½å¾Œé¢åœ–å±¤ï¼‰
- "stack" å †ç–Š
- "dodge" ä½µæ’
- "fill" å †ç–Šä¸¦ scale è‡³ 100%
- "jitter" "æŠ–..." é»æœƒäº’ç›¸é–ƒé¿


`position = "identity"`

- åŒä¸€ä½ç½®ï¼ˆè¦†è“‹ä½å¾Œé¢åœ–å±¤ï¼‰

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "identity", alpha = .4) +
  ggtitle('Position = "identity"')
```

`position = "dodge"`

- ä½µæ’

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "dodge") +
  ggtitle('Position = "dodge"')
```

`position = "fill"`

- å †ç–Šä¸¦ scale è‡³ 100%

```{r}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "fill") +
  ggtitle('Position = "fill"')
```

### Facets: Small-Multiples

Too many variables!!!!

- çœ‹åˆ°å‰›æ‰çš„è»Šè»Šæ²¹è€—ğŸš—ï¼Œæ˜¯ä¸æ˜¯è¦ºå¾—é‚„æ˜¯å¾ˆé›£é€éåœ–è¡¨ç†è§£è³‡æ–™ï¼Ÿ
- å‰›æ‰ç•«çš„åœ–å› ç‚ºå¤šäº†ç¬¬3å€‹è®Šæ•¸ï¼Œæ‰€ä»¥æ›´é›£ç†è§£äº†

```{r, echo=FALSE, fig.asp=0.35, fig.width=10}
p1 <- ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "stack") +
  ggtitle('Position = "stack"')
p2 <- ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class, fill = manufacturer),
           position = "dodge") +
  ggtitle('Position = "dodge"')
cowplot::plot_grid(p1, p2)
```

- Facets æ˜¯å¾ˆé‡è¦çš„ä¸€å€‹å‘ˆç¾æ–¹å¼ï¼Œä¸€å®šè¦å­¸èµ·ä¾†
- ç‚ºä»€éº¼è¦ç”¨ Facetsï¼Ÿ
    1. ç•¶åŒä¸€å€‹åº§æ¨™å¹³é¢å¡å…¥å¤ªå¤šè®Šæ•¸ï¼Œæœƒé€ æˆå¤§è…¦ç„¡æ³•è² è·
    2. åˆ†æ‹†è³‡è¨Šï¼Œè®“å¤§è…¦å”åŠ©è…¦è£œæ›´æœ‰æ•ˆç‡

<a href="https://en.wikipedia.org/wiki/Small_multiple">
<img src="img/horse-in-motion.jpg" style="height:100px; max-width:100%;">
</a>

> "Illustrations of postage-stamp size are indexed by category or a label, sequenced over time like the frames of a movie, or ordered by a quantitative variable not used in the single image itself." -- Edward Tufte

<div class="footer">
- http://www.juiceanalytics.com/writing/better-know-visualization-small-multiples
</div>


#### Facet Exercise

å„è»Šå» (`manufacturer`)åœ¨ä¸åŒè»Šå‹(`class`)çš„æ•¸é‡ç‚ºä½•ï¼Ÿ

å…ˆç”¨è¡¨æ ¼ä¾†æ€è€ƒ

- ä½ çš„ï¼ˆè¦–è¦ºåŒ–ï¼‰è¡¨æ ¼è¦æ€éº¼ç•«åˆ¥äººæ‰æœƒæ¸…æ¥š
- åœ¨æŠŠè¡¨æ ¼æ”¾åˆ°åœ–è¡¨ä¸Šé¢

ä¸‰å€‹è®Šæ•¸æ‡‰è©²æ€éº¼æ”¾ï¼š

- manufacturer
- class
- count

**1. Long-format**

æ˜¯æˆ‘å€‘åœ¨ `ggplot2` éœ€è¦æ‹¿ä¾†ç•«åœ–çš„è¡¨æ ¼

```{r, echo=FALSE}
mpg %>% 
  group_by(manufacturer, class) %>% 
  tally() %>% 
  head(10) %>% 
  knitr::kable()
```

**2. ç›´æ¥çœ‹å°±å¾ˆæ¸…æ¥šçš„è¡¨æ ¼**

- Pivot æ¨ç´åˆ†æè¡¨

```{r, echo=FALSE}
mpg %>% 
  group_by(manufacturer, class) %>% 
  tally() %>% 
  spread(class, n, fill = 0) %>% 
  knitr::kable()
```

**3. è®“è¦–è¦ºåŒ–å¢åŠ è³‡è¨Šçš„æ¸…æ™°åº¦: `facet_wrap()`**

ç•«å‡ºå„è»Šå» (`manufacturer`)åœ¨ä¸åŒè»Šå‹(`class`)çš„æ•¸é‡ bar chart

- x: class
- y: count
- <s>fill</s> åˆªæ‰å¤šé¤˜çš„ mapping
- facet: manufacturer

```{r, fig.width=10, fig.asp=0.8}
ggplot(data = mpg) +
  geom_bar(mapping = aes(x = class)) +
  facet_wrap( ~ manufacturer, ncol = 4) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

- åŸå‰‡ï¼š**ä¸€å€‹åº§æ¨™å¹³é¢(æ–¹æ ¼)æœ€å¥½ä¸è¦è¶…éä¸‰å€‹è®Šæ•¸**
- Don't [overplotting](http://www.perceptualedge.com/articles/visual_business_intelligence/over-plotting_in_graphs.pdf)
- æ‹†å‡ºé¡åˆ¥è®Šæ•¸ (nominal) æ”¾åœ¨å€‹åˆ¥çš„å°æ–¹æ ¼ (facets)

> ç•¶è®Šæ•¸å¾ˆå¤šæ™‚ Faceting å°±æ˜¯ä½ æœ€å¥½çš„æœ‹å‹ï¼


### Labels

åœ–è¡¨ä¸€å®šè¦æœ‰æ¨™é¡Œï¼Œåˆ¥äººæ‰çŸ¥é“ä½ è¦è¬›çš„æ•…äº‹æ˜¯ä»€éº¼

#### Title æ¨™é¡Œ

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(mapping = aes(color = class)) +
  geom_smooth() + 
  ggtitle("Fuel efficiency vs. Engine size")
```

#### æ¨™é¡Œ + åº§æ¨™è»¸

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(mapping = aes(color = class)) +
  geom_smooth() + 
  ggtitle("Fuel efficiency vs. Engine size") +
  xlab("Engine displacement (L)") +
  ylab("Highway fuel efficiency (mpg)") 
```

#### (é™„éŒ„) Theme

```{r}
ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(mapping = aes(color = class)) +
  geom_smooth() +
  theme_bw()
```

ggplot2 å…§å»º theme

<img src="img/visualization-themes.png" style="height:520px; max-width:100%;">

Theme ç›¸é—œå¥—ä»¶:

- [`ggthemes`](https://cran.r-project.org/web/packages/ggthemes/vignettes/ggthemes.html) (æ¨è–¦)
- [`ggthemr`](https://github.com/cttobin/ggthemr)


### Learning from copying å¾æŠ„åˆ¥äººçš„åœ–è¡¨å­¸èµ·

- Google: "åœ–è¡¨åç¨± + R"
- å¦‚æœè¦ç”¨å¾—é †æ‰‹ï¼Œå¹³å¸¸å°±è¦å¤šçœ‹åˆ¥äººç•«çš„å¥½åœ–ï¼Œè¦ç”¨æ™‚æ‰çŸ¥é“å¾å“ªè£¡æ‰¾èµ·
- Google æ˜¯å­¸ç¿’ç•«åœ–çš„å¥½æœ‹å‹
    <img src="img/google-ggplot2.png" style="max-height:auto; max-width:100%;">
- [è¦–è¦ºåŒ–è³‡æºæ•´ç†](#Resources)


### Export Plots åŒ¯å‡ºåœ–è¡¨

```{r, eval=FALSE}
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy)) +
  geom_point(mapping = aes(color = class)) +
  geom_smooth() +
  theme_bw()

ggsave(p,
       filename = "my_plot.png",
       device = "png", h = 2, w = 3, type = "cairo")
```

<img src="img/export-plot-1.png" style="max-height:auto; max-width:100%;">

<img src="img/export-plot-2.png" style="max-height:auto; max-width:100%;">

<img src="img/export-plot-3.png" style="max-height:auto; max-width:100%;">


## ggplot2 è¦–è¦ºåŒ–æµç¨‹ç¸½çµ

ggplot2 çš„ç¹ªåœ–æµç¨‹

<img src="img/ggplot2-basic.png" style="max-height:400px; max-width:100%;">

1. **Data** (noun/subject)
2. **Aesthetic mappings** (adjectives): x, y, color, size, ...
3. **Layers**: Geom (verb), Stat (adverb)
4. **Position** (preposition): Scales, Coord, Facet
5. **Theme**

è¦–è¦ºåŒ–æµç¨‹ (éå¸¸é‡è¦ï¼)

+ Issue: é€™å¼µåœ–è¡¨æƒ³è§£æ±ºçš„å•é¡Œæ˜¯ä»€éº¼ï¼Ÿ
+ Variables
    - variables needed from the data
+ Geoms
    - **bar chart**, **line chart**, **heat map**, ...
+ Aesthetic Mapping
    - x:
    - y: 
    - ...

## HW: ç•«è‡ªå·±çš„åœ–

- æ‰¾å‡ºä¸€å¼µå¹³å¸¸æœƒç•«çš„åœ–è¡¨ï¼Œä»¥åŠå…¶è³‡æ–™ï¼Œå¡«å…¥ä¸Šé¢æ ¼å¼
- è©¦è‘—ç”¨ `ggplot2` ç•«å‡ºä¾†
    - è³‡æ–™åŒ¯å…¥
    - è³‡æ–™å‰è™•ç†
    - ç•«åœ–
    - åŒ¯å‡ºæˆ png


<!-- ## å¦‚ä½•åŒ¯å…¥è³‡æ–™ -->

<!-- <img src="img/import-data-1.png" style="max-height:auto; max-width:100%;"> -->

<!-- <img src="img/import-data-2.png" style="max-height:auto; max-width:100%;"> -->

<!-- <img src="img/import-data-3.png" style="max-height:auto; max-width:100%;"> -->



## Resources è¦–è¦ºåŒ–è³‡æºæ•´ç†

#### Data Cleansing (ETL)

- dplyr
- tidyr
- broom

#### ggplot2 Cookbook and Documentation

- [ggplot2 å®˜æ–¹ä½¿ç”¨æ‰‹å†Š](http://docs.ggplot2.org/current/): å®Œæ•´ç¯„ä¾‹ç´°ç¯€
- [Cookbook for R - Graphs](http://www.cookbook-r.com/Graphs/): æ­¤ç«™å…¶ä»–å­¸ç¿’è³‡æºä¹Ÿå¾ˆæ¨è–¦

#### ggplot2 è¼”åŠ©ç¹ªåœ–

- [RColorBrewer](http://bxhorn.com/rcolorbrewer-palettes/): è‰²ç¥¨
- [ColorBrewer by PennState University](http://colorbrewer2.org/): Web tool for guidance in choosing choropleth map color schemes, based on the reasearch of Dr. Cynthia Brewer.
- [cowplot](https://cran.r-project.org/web/packages/cowplot/vignettes/introduction.html): çµ„åˆåœ–è¡¨
- [ggrepel](https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html): labeling ggplot
- [directlabels](http://directlabels.r-forge.r-project.org/docs/): labeling ggplot (has few bugs)
- [lemon](https://github.com/stefanedwards/lemon): Refresh axis lines, facets, pointpath

#### ggplot2 å»¶ä¼¸å¥—ä»¶æ•´ç†

- [ggplot2 Extensions & Gallery](https://www.ggplot2-exts.org/)

#### Cheatsheet

- [RStudio - ggplot2 Cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf)


#### Other Viz Packages

- [sjPlot](http://www.strengejacke.de/sjPlot/): å¿«é€Ÿç¹ªè£½çµ±è¨ˆæ¨¡å‹å’Œè¡¨æ ¼ (html output)
- [sjmisc](https://github.com/sjPlot/sjmisc): Utility and recode functions for R and sjPlot. è™•ç†å•å· variable, label, spss file, ...
- [dygraphs](http://rstudio.github.io/dygraphs/): (RStudio) å‹•æ…‹ç¹ªè£½ time-series data
- [leaflet](https://rstudio.github.io/leaflet/): [Leaflet](http://leafletjs.com/) åœ°åœ–
- [ggvis](http://ggvis.rstudio.com/): (hadley) å‹•æ…‹åœ–è¡¨ï¼Œå¯æ­é… Shinyï¼Œå°šæœªæœ‰å®Œæ•´æ‡‰ç”¨é«”ç³»
- [rCharts](https://github.com/ramnathv/rCharts): (åœæ­¢é–‹ç™¼å¾ˆä¹…) å‹•æ…‹åœ–è¡¨

#### R Plot Galleries

- [R Graph Catalog - Creating More Effective Graphs](http://shiny.stat.ubc.ca/r-graph-catalog/): æœ‰æ•ˆåœ–è¡¨çš„æœ€ç°¡ç¯„ä¾‹é›†
- [R å‹•æ…‹åœ–è¡¨å¥—ä»¶é›† - htmlwidgets](http://gallery.htmlwidgets.org/)
- [RStudio - Quick list of useful R packages](https://support.rstudio.com/hc/en-us/articles/201057987-Quick-list-of-useful-R-packages)
- [THE R GRAPH GALLERY](http://www.r-graph-gallery.com/)
- [R graph gallery](http://rgraphgallery.blogspot.tw/)

#### Other Plot Galleries

- [The Data Visualisation Catalogue](http://www.datavizcatalogue.com/index.html): å„ç¨®åœ–è¡¨é¡å‹ç¯„ä¾‹
- [The Economist - Graphic detail](http://www.economist.com/blogs/graphicdetail): çœ‹ç¶“æ¿Ÿå­¸äººå¦‚ä½•ç”¨åœ–è¡¨èªªæ•…äº‹

#### è¦–è¦ºåŒ–å¿ƒæ³•

- [junkcharts](http://junkcharts.typepad.com/)
- [Stephen Few - Perceptual Edge](http://www.perceptualedge.com/examples.php)
- [è³‡æ–™è¦–è¦ºåŒ–](hhttp://blog.infographics.tw/category/%E5%BF%83%E6%B3%95/)

